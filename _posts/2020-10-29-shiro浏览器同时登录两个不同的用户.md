---
layout: post
title: "shiroæµè§ˆå™¨åŒæ—¶ç™»å½•ä¸¤ä¸ªä¸åŒçš„ç”¨æˆ·"
date: 2020-10-29 21:11:14 +0800
tags: java
description: 
---

ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œåœ¨è§£å†³äº†ä¸¤ä¸ªç”¨æˆ·ç™»å½•çš„é—®é¢˜ä¹‹åï¼Œåˆå‘ç°äº†æ–°çš„é—®é¢˜ï¼š
> åœ¨åŒä¸€ä¸ªæµè§ˆå™¨å…ˆç™»å½•ç”¨æˆ·Aï¼Œå†å»è®¿é—®åŸæœ¬ç”¨æˆ·Béœ€è¦ç™»å½•æ‰å¯ä»¥è®¿é—®çš„é“¾æ¥ï¼Œå°±ä¼šç›´æ¥è¿›å…¥ï¼Œä¸å†è·³è½¬å›ç™»å½•é¡µé¢
>
> å½“ç›´æ¥è®¿é—®ç”¨æˆ·Bçš„é“¾æ¥æ—¶ï¼Œè·å–å·²ç»ç™»å½•çš„ç”¨æˆ·å¯¹è±¡ï¼Œå–å‡ºæ¥çš„ä»ç„¶æ˜¯ç”¨æˆ·A

é¦–å…ˆï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªé—®é¢˜çš„åŸå› ï¼Œè§‚å¯Ÿé…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œå‘ç°ç”¨æˆ·Aå’Œç”¨æˆ·Bä½¿ç”¨çš„è®¤è¯è§„åˆ™éƒ½æ˜¯shiroä¸­çš„**FormAuthenticationFilter**ç±»,è€ŒFormAuthenticationFilterç±»ç»§æ‰¿è‡ªAuthenticatingFilterç±»ï¼Œåœ¨è¯¥ç±»ä¸­ï¼ŒisAccessAllowedå‡½æ•°ï¼Œç”¨æ¥æ£€æµ‹ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼›è¿›åˆ°isAccessAllowedå‡½æ•°ä¸­ï¼š
{% highlight java %}
protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue) {
    return super.isAccessAllowed(request, response, mappedValue) || !this.isLoginRequest(request, response) && this.isPermissive(mappedValue);
}
{% endhighlight %}

å‘ç°çˆ¶ç±»çš„isAccessAllowedå‡½æ•°ï¼Œæ˜¯æ§åˆ¶çš„å…³é”®ï¼Œå†æ¬¡è¿›å…¥åˆ°isAccessAllowedå‡½æ•°ä¸­ï¼š
{% highlight java %}
protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue) {
    Subject subject = this.getSubject(request, response);
    return subject.isAuthenticated();
}
{% endhighlight %}
æ£€æµ‹æ˜¯å¦å…è®¸è®¿é—®çš„ï¼Œåªæ˜¯æ£€æµ‹subjectå¯¹è±¡æ˜¯å¦ä¸ºè®¤è¯çŠ¶æ€ï¼ˆä¹Ÿå°±æ˜¯å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨ç™»å½•ä¿¡æ¯ï¼‰

æ‰€ä»¥åœ¨åŒä¸€æµè§ˆå™¨ä¸­ï¼Œç”¨æˆ·Aå·²ç»ç™»å½•ï¼Œè®¿é—®ç”¨æˆ·Bçš„é“¾æ¥æ—¶ï¼ŒSubjectå¯¹è±¡ä¸­å·²ç»å­˜åœ¨ä¿¡æ¯ï¼Œæ‰€ä»¥ä¼šå…è®¸è®¿é—®ï¼Œè€ŒåŒæ—¶ï¼Œç¬¬äºŒä¸ªé—®é¢˜ä¹Ÿæ‰¾åˆ°äº†

è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ä¸åŒçš„æµè§ˆå™¨è®¿é—®ï¼Œå°±ä¸ä¼šå‡ºç°ï¼Œæ‰€ä»¥æ„Ÿè§‰æ˜¯sessionidçš„é—®é¢˜ï¼Œä½†æ˜¯ä¸ºæ¯ä¸ªèº«ä»½é…ç½®äº†ä¸åŒçš„sessionidä¹Ÿæ²¡èµ·ä½œç”¨ï¼ˆå¯èƒ½æ˜¯æˆ‘å¤„ç†çš„æ–¹æ³•ä¸å¤ªå¯¹ğŸ˜”ï¼‰ã€‚äºæ˜¯æƒ³åˆ°äº†å¦å¤–ä¸€ç§è§£å†³åŠæ³•

## ---------------------------æˆ‘æ˜¯åä¸½çš„åˆ†å‰²çº¿---------------------------

æˆ‘ä»¬åœ¨è‡ªå®šä¹‰çš„realmå¯¹è±¡ä¸­ï¼Œæœ€åä¸€æ­¥æ„é€ äº†AuthenticationInfoå¯¹è±¡
{% highlight java %}
SimpleAuthenticationInfo simpleAuthenticationInfo = new SimpleAuthenticationInfo(admin,pass,getName());
{% endhighlight %}
å¯ä»¥çœ‹å‡ºï¼Œæ˜¯å§è‡ªå®šä¹‰å¯¹è±¡ï¼Œå’Œå½“å‰realmçš„åç§°ä¼ å…¥åˆ°SimpleAuthenticationInfoç±»ä¸­ï¼Œç‚¹è¿›å»çœ‹SimpleAuthenticationInfoçš„æ„é€ å‡½æ•°ï¼š
ï¼[](/images/2020-10-29-1.png)

ä¸Šé¢çš„æ˜¯æˆ‘ä»¬åŸæ¥ä½¿ç”¨çš„ï¼Œå‘ç°æ˜¯æŠŠæˆ‘ä»¬ä¼ é€’çš„å¯¹è±¡æ”¾åœ¨äº†SimplePrincipalCollectionç±»ä¸­ï¼Œçœ‹åå­—ï¼Œè¿™ä¸ªç±»åº”è¯¥æ˜¯å¯ä»¥å‚¨å­˜å¤šä¸ªå¯¹è±¡ã€‚ç»§ç»­å¾€ä¸‹èµ°ï¼Œå‘ç°SimplePrincipalCollectionç±»ä¸­ï¼Œå®šä¹‰äº†addå’ŒaddAllä¸¤ä¸ªå‡½æ•°ï¼Œè€Œä¸”å…¶ä¸­ä¸€ä¸ªæ„é€ å‡½æ•°çš„å‚æ•°è¿˜æ˜¯Collectionç±»å‹ï¼Œè¯æ˜æ˜¯å¯ä»¥å‚¨å­˜å¤šä¸ªå€¼çš„ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯åœ¨åˆ›å»ºSimpleAuthenticationInfoç±»çš„æ—¶å€™ï¼Œä¹Ÿåº”è¯¥å¯ä»¥ä¼ å…¥PrincipalCollectionæ‰å¯¹ï¼Œæœç„¶åœ¨æˆ‘ä»¬ä¹‹å‰çš„æ„é€ å‡½æ•°ä¸‹æ–¹åˆå‘ç°äº†ä¸€ä¸ªæ„é€ å‡½æ•°
{% highlight java %}
public SimpleAuthenticationInfo(PrincipalCollection principals, Object credentials) {
    this.principals = new SimplePrincipalCollection(principals);
    this.credentials = credentials;
}
{% endhighlight %}

è¿™å›å¤§æ¦‚æœ‰äº†è§£å†³çš„æ€è·¯äº†ï¼š
> 1.åœ¨realmå¤„ç†ç™»å½•çš„æ—¶å€™ï¼Œå…ˆæŸ¥è¯¢åŸæ¥æ˜¯ä¸æ˜¯å·²ç»å­˜åœ¨SimplePrincipalCollectionå¯¹è±¡
> 2.å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¯æ˜å½“å‰ç”¨æˆ·æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼Œç›´æ¥è¿›è¡Œæ­£å¸¸çš„ç™»å½•é€»è¾‘
> 3.å¦‚æœå­˜åœ¨ï¼Œåˆ™è¯æ˜å·²ç»ç™»å½•å…¶ä»–çš„ç”¨æˆ·ï¼Œè·å–SimplePrincipalCollectionå¯¹è±¡ï¼Œå¹¶è°ƒç”¨addå‡½æ•°å°†å½“å‰å¯¹è±¡ä¿¡æ¯åŠ å…¥ï¼Œåœ¨åˆ›å»ºSimpleAuthenticationInfoå¯¹è±¡ã€‚

å¯¹åº”çš„å…³é”®ä½ç½®çš„ä»£ç å¦‚ä¸‹ï¼š
{% highlight java %}
protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
	//apache shiroè·å–sessionä¸­æ˜¯å¦å­˜åœ¨å…¶ä»–ç”¨æˆ·
    SimplePrincipalCollection spc = null;
    Collection<Session> sessions = sessionDAO.getActiveSessions();
    for (Session session : sessions){
        spc = (SimplePrincipalCollection)session.getAttribute("org.apache.shiro.subject.support.DefaultSubjectContext_PRINCIPALS_SESSION_KEY");
    }
    //å½“å‰ç”¨æˆ·çš„ç™»å½•é€»è¾‘ï¼Œè´¦å·å¯†ç æ£€æµ‹ç­‰.....

    //å¤„ç†ç”¨æˆ·ä¿¡æ¯
    SimpleAuthenticationInfo simpleAuthenticationInfo = null;
    if(spc != null){
        //å­˜åœ¨å…¶ä»–ç”¨æˆ·ï¼Œè¿½åŠ å½“å‰
        spc.add(admin,getName());
        simpleAuthenticationInfo = new SimpleAuthenticationInfo(spc,pass);
    }else{
        simpleAuthenticationInfo = new SimpleAuthenticationInfo(admin,pass,getName());
    }

    return simpleAuthenticationInfo;
}
{% endhighlight %}

ç™»å½•éƒ¨åˆ†å¤„ç†å®Œï¼Œä¹‹åè¿˜è¦å¯¹isAccessAllowedå‡½æ•°è¿›è¡Œé‡å†™ï¼Œæ ¹æ®è®¿é—®çš„urlï¼Œæ‰‹åŠ¨æ£€æµ‹å¯¹åº”çš„å¯¹è±¡ä¿¡æ¯æ˜¯å¦å­˜åœ¨
{% highlight java %}
protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue) {
    Subject subject = getSubject(request,response);
    //è·å–è®¿é—®çš„urlã€‚
    String uri = getPathWithinApplication(request);
    //åˆ¤æ–­æ˜¯å¦ç™»é™†
    boolean isAuthc = subject.isAuthenticated();
    //æœªç™»é™†ï¼Œç›´æ¥è¿”å›
    if(isAuthc == false){
        return isAuthc;
    }
    //è·å–subjectä¸­å¾—realmå¯¹è±¡
    PrincipalCollection realms = subject.getPrincipals();
    Set<String> realmNames = realms.getRealmNames();
    //è‡ªå®šä¹‰å‡½æ•°ï¼Œåˆ¤æ–­urlæ˜¯å¦å¯ä»¥è®¿é—®ï¼Œæ ¹æ®urlåˆ¤æ–­å¯¹åº”realmæ˜¯å¦å­˜åœ¨
    boolean isAllowed = isUriAllow(uri,realmNames);

    return isAllowed;
}
{% endhighlight %}

è¿™äº›å·¥ä½œåšå®Œä¹‹åï¼Œè®°å¾—ä¿®æ”¹xmlé…ç½®æ–‡ä»¶ä¸­å¼•ç”¨ç±»çš„è·¯å¾„ï¼ŒæŠŠåŸæ¥çš„org.apache.shiro.web.filter.authc.FormAuthenticationFilteræ¢ä¸ºæˆ‘ä»¬é‡å†™çš„ç±»è·¯å¾„ã€‚

åŒæ—¶ï¼Œåœ¨ç™»é™†æˆåŠŸåï¼Œè·å–ç”¨æˆ·ä¿¡æ¯çš„æ—¶å€™ï¼Œä¹Ÿè¦æ”¹ä¸ºsubjectçš„getPrincipals()å‡½æ•°ï¼Œè·å–PrincipalCollectionç±»ï¼Œå†åœ¨å…¶ä¸­è·å–åˆ°å½“å‰urléœ€è¦çš„å†…å®¹
{% highlight java %}
Subject subject = SecurityUtils.getSubject();
PrincipalCollection pc = subject.getPrincipals();
{% endhighlight %}

è™½ç„¶æ²¡æœ‰æ‰¾åˆ°å…¶ä»–äººçš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å¥½æ­¹è¿˜æ˜¯è‡ªå·±é€šè¿‡çœ‹æºç +Debugçš„æ–¹å¼ï¼Œæ‰¾åˆ°äº†éœ€è¦é‡å†™çš„å‡½æ•°å’Œå¯¹è±¡ï¼Œè§£å†³äº†è¿™ä¸ªé—®é¢˜
![](/images/2020-10-29-2.jpg)